# Dokumentacja Architektury Systemu dla Audytu AI (OPISAI.MD)

Niniejszy dokument stanowi szczegÃ³Å‚owy opis techniczny aplikacji "Trading Bot VPS Companion", przygotowany w celu umoÅ¼liwienia przeprowadzenia audytu przez systemy sztucznej inteligencji lub audytorÃ³w technicznych. Dokument koncentruje siÄ™ na architekturze, przepÅ‚ywie danych, zarzÄ…dzaniu modelami oraz mechanizmach weryfikacji.

---

## 1. Wprowadzenie i Cel Aplikacji

### Cel Systemu
GÅ‚Ã³wnym celem systemu jest **automatyzacja analizy rynkÃ³w finansowych** oraz **wspomaganie decyzji inwestycyjnych uÅ¼ytkownika** w czasie rzeczywistym. System dziaÅ‚a jako inteligentny asystent (Companion), ktÃ³ry:
1.  Monitoruje tysiÄ…ce instrumentÃ³w finansowych (Akcje, Forex, Krypto) w trybie 24/7.
2.  Filtruje szum rynkowy, identyfikujÄ…c jedynie sygnaÅ‚y o wysokim prawdopodobieÅ„stwie sukcesu.
3.  Wykorzystuje modele Machine Learning do oceny jakoÅ›ci sygnaÅ‚Ã³w ("Score").
4.  Dostarcza sformatowane rekomendacje bezpoÅ›rednio na komunikator Telegram.
5.  Gromadzi dane zwrotne od uÅ¼ytkownika w celu douczania modeli (PÄ™tla sprzÄ™Å¼enia zwrotnego).

### Grupa Docelowa
*   **Inwestorzy Indywidualni**: UÅ¼ytkownicy koÅ„cowi podejmujÄ…cy decyzje na podstawie sygnaÅ‚Ã³w.
*   **Audytorzy SystemÃ³w AI**: Podmioty weryfikujÄ…ce zgodnoÅ›Ä‡ algorytmÃ³w z zaÅ‚oÅ¼eniami ryzyka.
*   **Developerzy AI/ML**: Osoby odpowiedzialne za trenowanie i wdraÅ¼anie modeli predykcyjnych.

---

## 2. Architektura Systemu

System oparty jest na **architekturze zdarzeniowej (Event-Driven Architecture)** z centralnÄ… szynÄ… danych (`EventBus`). Pozwala to na luÅºne powiÄ…zanie moduÅ‚Ã³w (decoupling) i asynchroniczne przetwarzanie duÅ¼ych wolumenÃ³w danych.

### Diagram Wysokopoziomowy (Tekstowy)

```mermaid
graph TD
    DataSources[Yahoo Finance / News / User] --> DataEngine
    DataEngine -->|MarketData Event| EventBus
    
    EventBus --> StrategyEngine
    StrategyEngine -->|RawSignal Event| ML_Advisor
    
    ML_Advisor[ML Client + Server] -->|ScoredSignal Event| RiskEngine
    RiskEngine -->|ValidatedSignal Event| TelegramBot
    
    TelegramBot -->|UserAction Event| GamificationEngine
    TelegramBot -->|UserAction Event| LearningDatabase
    
    subgraph Core
        EventBus
        Config
        LoggingSystem
    end
```

### Kluczowe Technologie
*   **JÄ™zyk**: Python 3.9+ (Asyncio).
*   **Komunikacja**: WewnÄ™trzny `EventBus` (Pub/Sub).
*   **ML**: `scikit-learn` (Random Forest), `aiohttp` (komunikacja z serwerem ML).
*   **Dane**: `yfinance` (ceny), `ForexFactory` (kalendarz - scraping).
*   **Interfejs**: Telegram Bot API.

---

## 3. SzczegÃ³Å‚owy Opis ModuÅ‚Ã³w

### 3.1. ModuÅ‚ ZarzÄ…dzania Modelami (AI/ML)
*   **Kod ÅºrÃ³dÅ‚owy**: `app/ml/client.py`, `app/ml/server/` (zewnÄ™trzny).
*   **Cel**: Ocena jakoÅ›ci sygnaÅ‚u wygenerowanego przez strategiÄ™ technicznÄ…. Model nie przewiduje ceny, lecz **prawdopodobieÅ„stwo akceptacji sygnaÅ‚u przez uÅ¼ytkownika** (Personalizacja) lub ogÃ³lnÄ… jakoÅ›Ä‡ technicznÄ….
*   **GÅ‚Ã³wne Mechaniki**:
    *   Klient (`MlAdvisorClient`) wysyÅ‚a wektor cech (RSI, MACD, Volatility, Time) do serwera ML.
    *   Serwer zwraca `ml_score` (0-100) oraz flagÄ™ `blacklisted` (czy instrument jest na czarnej liÅ›cie ML).
    *   ObsÅ‚uga trybu "Shadow Mode" (model ocenia w tle, ale nie blokuje sygnaÅ‚Ã³w).
*   **ZaleÅ¼noÅ›ci**: ZewnÄ™trzny serwer ML (REST API), pliki konfiguracyjne modeli (`.joblib`).
*   **Przechowywanie Danych**: `learning_database.json` (baza wiedzy do re-treningu).

### 3.2. ModuÅ‚ TestÃ³w i Walidacji (Backtesting)
*   **Kod ÅºrÃ³dÅ‚owy**: `app/backtest_runner.py`, `app/instrument_stats_builder.py`.
*   **Cel**: Weryfikacja skutecznoÅ›ci strategii na danych historycznych przed ich uÅ¼yciem w trybie Live.
*   **GÅ‚Ã³wne Mechaniki**:
    *   Symulacja "Å›wieca po Å›wiecy" na danych historycznych.
    *   Obliczanie metryk: Winrate, Risk:Reward Ratio, Max Drawdown, Profit Factor.
    *   Generowanie raportÃ³w skutecznoÅ›ci per instrument.
*   **Przechowywanie Danych**: Wyniki w `backtest_results/*.json`.

### 3.3. ModuÅ‚ Raportowania i Interfejsu (Telegram)
*   **Kod ÅºrÃ³dÅ‚owy**: `app/telegram_bot/`, `app/analysis/briefing.py`.
*   **Cel**: Prezentacja wynikÃ³w analizy w sposÃ³b zrozumiaÅ‚y dla czÅ‚owieka oraz odbieranie komend sterujÄ…cych.
*   **GÅ‚Ã³wne Mechaniki**:
    *   Formatowanie wiadomoÅ›ci z uÅ¼yciem Markdown (kolorowe statusy, emoji).
    *   ObsÅ‚uga interaktywnych przyciskÃ³w (Callback Query) do feedbacku (`âœ…`, `âŒ`) i zarzÄ…dzania pozycjami (`Zamknij`).
    *   Generowanie porannych odpraw (`Briefing`) z podsumowaniem sentymentu rynkowego.
*   **Interfejsy**: Telegram Bot API (Webhook/Polling).

### 3.4. ModuÅ‚ Logowania i Åšledzenia (Audit Trail)
*   **Kod ÅºrÃ³dÅ‚owy**: `app/logging_system/`, `app/diagnostics.py`.
*   **Cel**: Zapewnienie peÅ‚nej identyfikowalnoÅ›ci dziaÅ‚aÅ„ systemu (kto, co, kiedy) oraz monitorowanie stanu zdrowia aplikacji.
*   **GÅ‚Ã³wne Mechaniki**:
    *   Logowanie strukturalne (JSON/Text) do plikÃ³w rotowanych.
    *   Åšledzenie peÅ‚nego cyklu Å¼ycia sygnaÅ‚u: od pobrania ceny, przez decyzjÄ™ ML, po wysÅ‚anie wiadomoÅ›ci.
    *   `TradeLogger`: Zapisywanie kaÅ¼dej zamkniÄ™tej transakcji do trwaÅ‚ej historii.
*   **Przechowywanie Danych**: `logs/app.log`, `logs/errors.log`, `app/data/trade_history.json`.

---

## 4. PrzepÅ‚yw Danych (Data Flow Pipeline)

Proces decyzyjny przebiega wedÅ‚ug Å›ciÅ›le okreÅ›lonej sekwencji ("Lejek Decyzyjny"):

1.  **Ingestia Danych**: `DataEngine` pobiera Å›wiece (OHLCV) z Yahoo Finance oraz dane makro z kalendarza.
2.  **Publikacja Zdarzenia**: Zdarzenie `MARKET_DATA` trafia na `EventBus`.
3.  **Analiza Strategiczna**: `StrategyEngine` subskrybuje dane. JeÅ›li wskaÅºniki (RSI, MACD, EMA) speÅ‚niajÄ… warunki -> generuje `RawSignal`.
4.  **Wzbogacanie ML**: `RawSignal` jest przechwytywany, a `MlAdvisorClient` odpytuje serwer ML o ocenÄ™ (`ml_score`).
5.  **Kontrola Ryzyka**: `RiskEngine` weryfikuje `ml_score` (np. musi byÄ‡ > 60%), sprawdza filtry newsowe ("High Impact") i wylicza wielkoÅ›Ä‡ pozycji (SL/TP).
6.  **Dystrybucja**: JeÅ›li wszystkie bramki sÄ… otwarte, zdarzenie `SIGNAL_READY` trafia do `TelegramBot`.
7.  **Interakcja**: UÅ¼ytkownik podejmuje decyzjÄ™. Jego akcja (klikniÄ™cie) generuje zdarzenie `USER_DECISION`, ktÃ³re aktualizuje `learning_database.json` (feedback dla ML).

---

## 5. Wymagania Niefunkcjonalne

*   **WydajnoÅ›Ä‡**:
    *   Przetwarzanie pÄ™tli decyzyjnej dla jednego instrumentu < 100ms.
    *   ObsÅ‚uga do 500 instrumentÃ³w w cyklu 5-minutowym (wymagana asynchronicznoÅ›Ä‡ I/O).
*   **DostÄ™pnoÅ›Ä‡**:
    *   System zaprojektowany do pracy ciÄ…gÅ‚ej (24/7) na serwerze VPS.
    *   Autorestart w przypadku awarii procesu (obsÅ‚uga przez `systemd` lub Docker).
*   **BezpieczeÅ„stwo**:
    *   Brak przechowywania wraÅ¼liwych danych uÅ¼ytkownika (tylko ID Telegrama).
    *   Tokeny API przechowywane w zmiennych Å›rodowiskowych (`.env`).
*   **ZgodnoÅ›Ä‡ (Auditability)**:
    *   KaÅ¼da decyzja systemu (rÃ³wnieÅ¼ odrzucenie sygnaÅ‚u) musi byÄ‡ logowana z podaniem przyczyny (np. "Odrzucono: Zbyt niski ML Score").
    *   MoÅ¼liwoÅ›Ä‡ odtworzenia decyzji na podstawie historycznych danych (Backtesting).

---

## 6. Podsumowanie, Opinia i Sugestie Weryfikacyjne

### Opinia o Architekturze
Proponowana architektura wykazuje wysoki poziom dojrzaÅ‚oÅ›ci technicznej, szczegÃ³lnie w aspekcie modularnoÅ›ci i separacji odpowiedzialnoÅ›ci (Event Bus).
*   **Mocne strony**:
    *   Zastosowanie asynchronicznoÅ›ci (`asyncio`) zapewnia skalowalnoÅ›Ä‡ przy pobieraniu danych z wielu ÅºrÃ³deÅ‚.
    *   Jasny podziaÅ‚ na etapy decyzyjne ("Lejek") uÅ‚atwia debugowanie i audytowanie, dlaczego dany sygnaÅ‚ zostaÅ‚ lub nie zostaÅ‚ wygenerowany.
    *   Integracja pÄ™tli zwrotnej (Feedback Loop) pozwala na ciÄ…gÅ‚e doskonalenie modeli ML.
*   **Ryzyka**:
    *   ZaleÅ¼noÅ›Ä‡ od zewnÄ™trznych dostawcÃ³w danych (Yahoo Finance) bez wbudowanego mechanizmu failover na inne ÅºrÃ³dÅ‚o.
    *   Potencjalne opÃ³Åºnienia sieciowe w komunikacji z serwerem ML (jeÅ›li nie jest lokalny).

### Sugestie do Weryfikacji (Checklista Audytora AI)
W celu peÅ‚nej walidacji systemu, zaleca siÄ™ przeprowadzenie nastÄ™pujÄ…cych testÃ³w:

1.  **Weryfikacja ModuÅ‚u ML**:
    *   "Czy system poprawnie obsÅ‚uguje niedostÄ™pnoÅ›Ä‡ serwera ML (fallback do logiki sztywnej)?"
    *   "Czy model jest odporny na zjawisko 'data drift' (zmiany charakterystyki rynku w czasie)?"
2.  **Testy WydajnoÅ›ciowe**:
    *   "Jak system zachowuje siÄ™ przy nagÅ‚ym skoku zmiennoÅ›ci (duÅ¼a liczba zdarzeÅ„ rynkowych jednoczeÅ›nie)?"
    *   "Czy opÃ³Åºnienie miÄ™dzy pobraniem ceny a wysÅ‚aniem sygnaÅ‚u nie przekracza akceptowalnego progu (np. 2 sekundy)?"
3.  **SpÃ³jnoÅ›Ä‡ Danych**:
    *   "Czy wyniki BacktestÃ³w pokrywajÄ… siÄ™ z wynikami rzeczywistymi (Paper Trading)?"
    *   "Czy system poprawnie interpretuje podziaÅ‚y akcji (splits) i dywidendy w danych historycznych?"
4.  **ZgodnoÅ›Ä‡ z PolitykÄ… Ryzyka**:
    *   "PrzetestowaÄ‡ scenariusz 'Czarnego ÅabÄ™dzia' (nagÅ‚y spadek o 20%) - czy Stop Lossy sÄ… respektowane bezwarunkowo?"

Dokument przygotowany dnia: 2026-01-28.
Wersja systemu: 2.0 (VPS Companion).

---

## 7. Rozszerzenia Klasy Instytucjonalnej (Institutional-Grade Extensions)

W celu podniesienia standardu systemu do poziomu 10/10, architektura zostaÅ‚a rozszerzona o 5 kluczowych warstw zapewniajÄ…cych bezpieczeÅ„stwo kapitaÅ‚u i transparentnoÅ›Ä‡ decyzji.

### 7.1. Portfolio Context Layer (Kontekst Portfela)
*   **ModuÅ‚**: `app/portfolio/context.py`
*   **Cel**: Zapobieganie nadmiernej ekspozycji na skorelowane aktywa.
*   **Logika**: Przed otwarciem nowej pozycji, system sprawdza:
    *   CaÅ‚kowitÄ… ekspozycjÄ™ walutowÄ… (np. max 3 pozycje z USD).
    *   KorelacjÄ™ z obecnymi pozycjami (np. nie kupuj EURUSD jeÅ›li masz short GBPUSD).
    *   "Heatmap" ryzyka caÅ‚ego portfela.

### 7.2. Market Regime Detection Engine (Silnik Detekcji ReÅ¼imu Rynku)
*   **ModuÅ‚**: `app/analysis/market_regime.py`
*   **Cel**: Dynamiczne dostosowanie strategii do warunkÃ³w rynkowych.
*   **Klasyfikacja**:
    *   **TRENDING**: Silny trend (ADX > 25). Strategia: Trend Follow (SL szerszy).
    *   **RANGING**: Konsolidacja (ADX < 20). Strategia: Mean Reversion (ciasny TP).
    *   **HIGH_VOLATILITY**: Wysoka zmiennoÅ›Ä‡ (ATR > 2x Å›rednia). Strategia: Ochrona kapitaÅ‚u (zmniejszenie pozycji o 50%).

### 7.3. Equity-Aware Risk Feedback Loop (PÄ™tla Zwrotna KapitaÅ‚u)
*   **ModuÅ‚**: `app/risk/equity_guard.py`
*   **Cel**: Ochrona przed seriÄ… strat (Drawdown Protection).
*   **Zasada**: Hard-stop dla tradingu po osiÄ…gniÄ™ciu dziennego limitu straty (np. -2% kapitaÅ‚u).
*   **Mechanizm**: `CircuitBreaker` blokuje otwieranie nowych pozycji do koÅ„ca sesji (reset o 00:00 UTC).

### 7.4. Explainable ML Output (WyjaÅ›nialnoÅ›Ä‡ ML)
*   **ModuÅ‚**: `app/ml/explainability.py`
*   **Cel**: Zrozumienie "dlaczego" model podjÄ…Å‚ decyzjÄ™ (XAI).
*   **Implementacja**:
    *   Analiza wagi cech (Feature Importance) dla kaÅ¼dej predykcji.
    *   Komunikat dla uÅ¼ytkownika: "ML Score 85% (GÅ‚Ã³wne czynniki: Wysoki RSI, RosnÄ…cy Wolumen)".

### 7.5. Explicit NO-TRADE Feedback (Jawny Feedback Odrzucenia)
*   **Implementacja**: `PortfolioManager` / `LearningDatabase`
*   **Cel**: Gromadzenie danych o "utraconych okazjach" i poprawnych odrzuceniach.
*   **DziaÅ‚anie**: System loguje nie tylko otwarte pozycje, ale takÅ¼e sygnaÅ‚y odrzucone przez filtry (np. "Odrzucono przez ReÅ¼im Rynku"). Pozwala to na trenowanie modeli na prÃ³bkach negatywnych (Negative Sampling).

---

## 8. Projekt Warstwy UI (Telegram Bot)

Zgodnie z wymogami "User-Friendly", interfejs Telegrama zostaÅ‚ podzielony na dwie odrÄ™bne strefy (Menu), aby oddzieliÄ‡ codzienne operacje uÅ¼ytkownika od zadaÅ„ administracyjnych.

### 8.1. Koncepcja DwÃ³ch Menu

1.  **MENU GÅÃ“WNE (User Menu):** DostÄ™pne dla uÅ¼ytkownika na co dzieÅ„. SÅ‚uÅ¼y do sprawdzania stanu portfela, rynku i sygnaÅ‚Ã³w. Jest w 100% bezpieczne (tylko odczyt lub bezpieczne przeÅ‚Ä…czniki).
2.  **MENU SYSTEMOWE (Admin Menu):** Ukryte pod przyciskiem "âš™ï¸ System". SÅ‚uÅ¼y do konfiguracji, restartÃ³w i diagnostyki. Wymaga Å›wiadomego dziaÅ‚ania.

### 8.2. Struktura Menu

#### A. Menu GÅ‚Ã³wne (`/menu`)
*   **ğŸ“Š Skaner Rynku:** WyÅ›wietla podsumowanie aktywnych sygnaÅ‚Ã³w i stanu rynku (ReÅ¼im).
*   **ğŸ’¼ Portfel:** Pokazuje otwarte pozycje, ekspozycjÄ™ walutowÄ… i wynik sesji.
*   **ğŸ§  Profil Tradera:** Statystyki gamifikacji (Level, XP) i postÄ™py w nauce.
*   **ğŸ“‰ Status Ryzyka:** BieÅ¼Ä…cy Drawdown, wykorzystanie limitÃ³w dziennych.
*   **âš™ï¸ System:** Przycisk przejÅ›cia do Menu Systemowego.

#### B. Menu Systemowe (Context / Admin)
*   **ğŸ–¥ï¸ Stan Serwera:** Uptime, zuÅ¼ycie RAM/CPU, status poÅ‚Ä…czeÅ„ API.
*   **ğŸ› ï¸ NarzÄ™dzia:** WymuÅ› pobranie danych, WyczyÅ›Ä‡ cache, Test poÅ‚Ä…czenia.
*   **âš ï¸ Tryb Awaryjny:** PrzeÅ‚Ä…cznik `PANIC BUTTON` (Zatrzymaj wszystko / Zamknij wszystko).
*   **ğŸ”™ PowrÃ³t:** PowrÃ³t do Menu GÅ‚Ã³wnego.

### 8.3. Zasady Interakcji
*   **Minimalizm:** Brak koniecznoÅ›ci wpisywania komend tekstowych. Wszystko obsÅ‚ugiwane przyciskami (Inline Keyboard).
*   **BezpieczeÅ„stwo:** Akcje krytyczne (np. "Zamknij wszystko") wymagajÄ… dodatkowego potwierdzenia ("Czy na pewno? TAK/NIE").
*   **Feedback:** KaÅ¼da akcja koÅ„czy siÄ™ komunikatem zwrotnym (np. "âœ… Cache wyczyszczony", "âŒ BÅ‚Ä…d poÅ‚Ä…czenia").

### 8.4. PrzykÅ‚adowy UkÅ‚ad PrzyciskÃ³w (Keyboard Layout)

**Widok GÅ‚Ã³wny:**
```
[ ğŸ“Š Skaner Rynku ] [ ğŸ’¼ Portfel ]
[ ğŸ§  Profil Tradera ] [ ğŸ“‰ Ryzyko ]
         [ âš™ï¸ System ]
```

**Widok Systemowy:**
```
[ ğŸ–¥ï¸ Status ] [ ğŸ“ Logi ]
[ ğŸ”„ Restart ] [ âš ï¸ PANIC ]
      [ ğŸ”™ PowrÃ³t ]
```
